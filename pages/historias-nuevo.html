<div class="patient-form-container">
    <!-- Header del Formulario -->
    <div class="form-header">
        <div class="header-content">
            <button class="back-button btn-secondary" onclick="router.navigate('historias')">
                <i class="fas fa-arrow-left"></i> Volver a la Lista
            </button>
            <div class="header-title">
                <h1>Nuevo Paciente</h1>
                <p>Complete la información del paciente para crear su historia médica</p>
            </div>
        </div>
    </div>

    <!-- Formulario de Registro -->
    <form id="patient-form" class="patient-registration-form">
        <!-- Foto del Paciente -->
        <div class="photo-upload-section">
            <div class="photo-upload-container">
                <div class="photo-preview" id="photo-preview">
                    <div class="photo-placeholder">
                        <i class="fas fa-user-plus"></i>
                    </div>
                </div>
                <div class="upload-controls">
                    <label for="patient-photo" class="upload-button">
                        <i class="fas fa-camera"></i>
                        Adjuntar Foto
                    </label>
                    <input type="file" id="patient-photo" accept="image/*" style="display: none;">
                    <p class="upload-hint">Haga clic o arrastre una imagen aquí<br>Formatos: JPG, PNG (máx. 5MB)</p>
                </div>
            </div>
        </div>

        <!-- Información Personal -->
        <div class="form-section">
            <div class="section-header">
                <h3><i class="fas fa-user"></i> Información Personal</h3>
            </div>
            
            <div class="form-grid">
                <!-- Primera fila -->
                <div class="form-group">
                    <label for="nationality" class="required">Nacionalidad</label>
                    <select id="nationality" name="nationality" required>
                        <option value="">Seleccione...</option>
                        <option value="Venezolana">Venezolana</option>
                        <option value="Colombiana">Colombiana</option>
                        <option value="Ecuatoriana">Ecuatoriana</option>
                        <option value="Peruana">Peruana</option>
                        <option value="Argentina">Argentina</option>
                        <option value="Brasileña">Brasileña</option>
                        <option value="Chilena">Chilena</option>
                        <option value="Otra">Otra</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="identification" class="required">Identificación (C.I/Pasaporte)</label>
                    <input type="text" id="identification" name="identification" placeholder="V-12431456" required>
                </div>

                <div class="form-group">
                    <label for="registration-date" class="required">Fecha de Historia</label>
                    <input type="date" id="registration-date" name="registrationDate" required>
                </div>

                <!-- Segunda fila -->
                <div class="form-group">
                    <label for="last-name" class="required">Apellidos</label>
                    <input type="text" id="last-name" name="lastName" placeholder="Ingrese apellidos completos" required>
                </div>

                <div class="form-group">
                    <label for="first-name" class="required">Nombres</label>
                    <input type="text" id="first-name" name="firstName" placeholder="Ingrese nombres completos" required>
                </div>

                <div class="form-group">
                    <!-- Campo vacío para alineación -->
                </div>

                <!-- Tercera fila -->
                <div class="form-group">
                    <label for="birth-date" class="required">Fecha de Nacimiento</label>
                    <input type="date" id="birth-date" name="birthDate" required>
                </div>

                <div class="form-group">
                    <label for="chronological-age">Edad Cronológica</label>
                    <input type="number" id="chronological-age" name="chronologicalAge" placeholder="Se calcula automáticamente" readonly>
                </div>

                <div class="form-group">
                    <label for="gender" class="required">Género</label>
                    <select id="gender" name="gender" required>
                        <option value="">Seleccione...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                    </select>
                </div>

                <!-- Cuarta fila -->
                <div class="form-group">
                    <label for="birth-place">Lugar de Nacimiento</label>
                    <input type="text" id="birth-place" name="birthPlace" placeholder="Ciudad, País">
                </div>

                <div class="form-group">
                    <label for="phone">Teléfono</label>
                    <input type="tel" id="phone" name="phone" placeholder="+58 412 1234567">
                </div>

                <div class="form-group">
                    <!-- Campo vacío para alineación -->
                </div>

                <!-- Quinta fila -->
                <div class="form-group">
                    <label for="civil-status">Estado Civil</label>
                    <select id="civil-status" name="civilStatus">
                        <option value="">Seleccione...</option>
                        <option value="Soltero/a">Soltero/a</option>
                        <option value="Casado/a">Casado/a</option>
                        <option value="Divorciado/a">Divorciado/a</option>
                        <option value="Viudo/a">Viudo/a</option>
                        <option value="Unión Libre">Unión Libre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="profession">Profesión</label>
                    <input type="text" id="profession" name="profession" placeholder="Ej: Ingeniero de Software">
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="ejemplo@correo.com">
                </div>
            </div>
        </div>

        <!-- Información de Residencia -->
        <div class="form-section">
            <div class="section-header">
                <h3><i class="fas fa-home"></i> Información de Residencia</h3>
            </div>
            
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="address">Dirección Completa</label>
                    <textarea id="address" name="address" rows="3" placeholder="Ingrese la dirección completa de residencia"></textarea>
                </div>
            </div>
        </div>

        <!-- Contacto de Emergencia -->
        <div class="form-section">
            <div class="section-header">
                <h3><i class="fas fa-phone-alt"></i> Contacto de Emergencia</h3>
            </div>
            
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="emergency-contact">Nombre y relación del contacto de emergencia</label>
                    <textarea id="emergency-contact" name="emergencyContact" rows="2" placeholder="Nombre completo, parentesco y teléfono de contacto"></textarea>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="router.navigate('historias')">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Historia
            </button>
        </div>
    </form>
</div>

<script>
// Funcionalidad del formulario de pacientes
class PatientForm {
    constructor() {
        this.form = document.getElementById('patient-form');
        this.init();
    }

    init() {
        // Establecer fecha actual en el campo de fecha de historia
        document.getElementById('registration-date').valueAsDate = new Date();
        
        // Calcular edad automáticamente cuando se cambie la fecha de nacimiento
        document.getElementById('birth-date').addEventListener('change', () => {
            this.calculateAge();
        });

        // Manejar subida de foto
        document.getElementById('patient-photo').addEventListener('change', (e) => {
            this.handlePhotoUpload(e);
        });

        // Manejar envío del formulario
        this.form.addEventListener('submit', (e) => {
            this.handleSubmit(e);
        });

        // Validación en tiempo real
        this.initValidation();
    }

    calculateAge() {
        const birthDate = new Date(document.getElementById('birth-date').value);
        const today = new Date();
        
        if (birthDate && birthDate <= today) {
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            document.getElementById('chronological-age').value = age;
        } else {
            document.getElementById('chronological-age').value = '';
        }
    }

    handlePhotoUpload(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('photo-preview');
        
        if (file) {
            // Validar tamaño del archivo (5MB máximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Máximo 5MB permitido.');
                return;
            }

            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                alert('Por favor seleccione un archivo de imagen válido.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `<img src="${e.target.result}" alt="Foto del paciente">`;
            };
            reader.readAsDataURL(file);
        }
    }

    initValidation() {
        const requiredFields = this.form.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            field.addEventListener('blur', () => {
                this.validateField(field);
            });
        });
    }

    validateField(field) {
        const value = field.value.trim();
        const fieldGroup = field.closest('.form-group');
        
        // Remover clases de validación anteriores
        fieldGroup.classList.remove('field-valid', 'field-error');
        
        if (field.hasAttribute('required') && !value) {
            fieldGroup.classList.add('field-error');
            return false;
        } else if (value) {
            fieldGroup.classList.add('field-valid');
        }
        
        // Validaciones específicas
        if (field.type === 'email' && value) {
            const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
            if (!emailRegex.test(value)) {
                fieldGroup.classList.remove('field-valid');
                fieldGroup.classList.add('field-error');
                return false;
            }
        }
        
        return true;
    }

    validateForm() {
        const requiredFields = this.form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!this.validateField(field)) {
                isValid = false;
            }
        });
        
        return isValid;
    }

    async handleSubmit(event) {
        event.preventDefault();
        
        if (!this.validateForm()) {
            this.showNotification('Por favor complete todos los campos requeridos', 'error');
            return;
        }

        const formData = new FormData(this.form);
        const patientData = {
            identification: formData.get('identification'),
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            fullName: `${formData.get('firstName')} ${formData.get('lastName')}`,
            birthDate: formData.get('birthDate'),
            chronologicalAge: parseInt(formData.get('chronologicalAge')),
            gender: formData.get('gender'),
            nationality: formData.get('nationality'),
            birthPlace: formData.get('birthPlace'),
            phone: formData.get('phone'),
            email: formData.get('email'),
            profession: formData.get('profession'),
            civilStatus: formData.get('civilStatus'),
            address: formData.get('address'),
            emergencyContact: formData.get('emergencyContact'),
            registrationDate: formData.get('registrationDate')
        };

        try {
            // Simular guardado en la base de datos
            await this.savePatient(patientData);
            
            this.showNotification('Paciente guardado exitosamente', 'success');
            
            // Redirigir a la lista después de un momento
            setTimeout(() => {
                router.navigate('historias');
            }, 2000);
            
        } catch (error) {
            console.error('Error al guardar paciente:', error);
            this.showNotification('Error al guardar el paciente. Intente nuevamente.', 'error');
        }
    }

    async savePatient(patientData) {
        // Simular llamada a API
        return new Promise((resolve) => {
            setTimeout(() => {
                console.log('Paciente guardado:', patientData);
                resolve();
            }, 1000);
        });
    }

    showNotification(message, type) {
        // Crear notificación temporal
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remover después de 3 segundos
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
}

// Inicializar cuando se cargue la página
document.addEventListener('DOMContentLoaded', () => {
    if (window.location.hash.includes('historias-nuevo')) {
        new PatientForm();
    }
});
</script>